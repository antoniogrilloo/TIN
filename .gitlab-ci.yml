# File .gitlab-ci.yml
image: maven:3.8.6-openjdk-18-slim

stages:
  - build
  - validate
  - test
  - docs
  - deploy

services:
  - name: mysql:8.0
    alias: mysql
    command:
      - --default-authentication-plugin=mysql_native_password

variables:
  MYSQL_ROOT_PASSWORD: Grillo_00
  MYSQL_DATABASE: db_tin
  MYSQL_USER: springuser
  MYSQL_PASSWORD: Grillo_00
  MYSQL_HOST: mysql
  MYSQL_PORT: 3306
  SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/db_tin
  SPRING_DATASOURCE_USERNAME: springuser
  SPRING_DATASOURCE_PASSWORD: Grillo_00

before_script:
  - apt-get update -qq && apt-get install -y build-essential curl

build:
  stage: build
  when: manual
  script:
    - mvn compile

validate:
  stage: validate
  when: manual
  script:
    - mvn validate
    #rules:
    # - if: '$CI_COMMIT_BRANCH =~ /^(Story|Task).*/'

test:
  stage: test
  when: manual
  script:
    - apt-get update && apt-get install -y default-mysql-client
    - echo "Waiting for MySQL to be ready..."
    - until mysql -h "$MYSQL_HOST" -u root -p"$MYSQL_ROOT_PASSWORD" -e "SHOW DATABASES;"; do echo "waiting for mysql"; sleep 1; done
    - mysql -h "$MYSQL_HOST" -u root -p"$MYSQL_ROOT_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS $MYSQL_DATABASE;"
    - mysql -h "$MYSQL_HOST" -u root -p"$MYSQL_ROOT_PASSWORD" -e "CREATE USER IF NOT EXISTS '$MYSQL_USER'@'%' IDENTIFIED BY '$MYSQL_PASSWORD';"
    - mysql -h "$MYSQL_HOST" -u root -p"$MYSQL_ROOT_PASSWORD" -e "GRANT ALL PRIVILEGES ON $MYSQL_DATABASE.* TO '$MYSQL_USER'@'%';"
    - mysql -h "$MYSQL_HOST" -u root -p"$MYSQL_ROOT_PASSWORD" -e "FLUSH PRIVILEGES;"
    - mvn test
    #- mvn javadoc:javadoc # Inserire istruzione per gen doc
  # rules:
  #   - if: '$CI_COMMIT_BRANCH =~ /^(Story|Task).*/ && $CI_COMMIT_REF_NAME =~ /^Sprint.*/'
  #  - if: '$CI_COMMIT_BRANCH == "main" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^Sprint.*/'

deploy:
  stage: deploy
  when: manual
  script:
    - mvn deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^Sprint.*/'


generate-swagger-docs:
  stage: docs
  image: maven:3.8.6-openjdk-18-slim
  script:
    - apt-get update && apt-get install -y curl wget git npm
    - git clone -b task_9 "https://oauth2:glpat-LZtQfZ1Zic-8SqBjQX4-@gitlab.com/a.grillo22/tin.git"
    - cd tin
    - npm install -g redoc-cli
    - mvn spring-boot:run &
    - sleep 30  # Tempo per avviare l'applicazione Spring Boot
    - curl -o swagger.json http://localhost:8080/v3/api-docs
    - redoc-cli bundle -o index.html swagger.json
    - git config --global user.email "a.grillo22@campus.unimib.it"
    - git config --global user.name "a.grillo22"
    - cd tin
    - mkdir public
    - mv ../index.html public/index.html
    - mkdir .public
    - cp -r public/* .public
    - git add .
    - git commit -m "Aggiorna documentazione Swagger"
    - git push origin task_9
  artifacts:
    paths:
      - tin/.public